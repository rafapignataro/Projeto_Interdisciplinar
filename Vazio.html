<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="pt-br">
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="viewport" content="width=800, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, minimal-ui, shrink-to-fit=no" />

	<title>Meu Joguinho</title>
	
	<style type="text/css">
		body {
			background: #000;
			padding: 0;
			margin: 0;
			color: #fff;
			font: normal 14px sans-serif;
		}
		canvas {
			display: block;
			margin: 0 auto;
            
		}
	</style>
</head>
<body>

	<div id="divJogo"></div>

	<script type="text/javascript" src="phaser.min.js"></script>
	<script type="text/javascript">
	//<![CDATA[
	"use strict";

	// Essa não é a forma mais "prosissional" de fazer, mas é a mais simples :)

	// Vamos chamar a variável de game, para ficar igual ao sandbox!
	var game = new Phaser.Game(1280, 720, Phaser.AUTO, "divJogo");

	function TelaInicial(game) {

		// A função init() não aparecia no sandbox porque eles fazem ela por nós lá! :)
		this.init = function () {

			game.input.maxPointers = 1;

			// Deixar o jogo executando, mesmo se o browser mudar de aba?
			game.stage.disableVisibilityChange = true;

			if (game.device.desktop) {
				// Configurações específicas para desktop

				// Como criamos o CSS acima, não precisamos centralizar via código
				game.scale.pageAlignHorizontally = false;
			} else {
				// Configurações específicas para celulares

				game.scale.scaleMode = Phaser.ScaleManager.SHOW_ALL;
				// Especifica o tamanho mímino e máximo para a área do jogo (de 400x300 até 800x600)
				game.scale.setMinMax(400, 300, 1280, 720);
				game.scale.forceLandscape = true;
				// Como criamos o CSS acima, não precisamos centralizar via código
				game.scale.pageAlignHorizontally = false;
			}

		}

		this.preload = function () {          
			game.load.crossOrigin = "anonymous";
            
            game.load.image('ship', 'Sprites/ship.png');
            game.load.image('missil1', 'Sprites/cannon_ball.png');
            game.load.spritesheet('explode', 'Sprites/explosion.png',64,64);
            game.load.image('inimigo', 'Sprites/inimigo.png');
            game.load.image('coracao', 'Sprites/heart.png');
            
            //Sprites mapa
            game.load.image('waterP', 'Sprites/Tileset_128.png');
            game.load.image('floEsquerda', 'Sprites/FlorestaEsquerda.png',300,2000);
            game.load.image('floDireita', 'Sprites/FlorestaDireita.png',300,2000);
            game.load.spritesheet('coin', 'Sprites/coin.png',32,32);
            
            

		}
            
        //Variaveis sprites
        var barco;
        var cursors;
        var atira;
        
        //Variaveis background
        var fundo
        var florestaEsquerda;
        var florestaDireita;
        
        
        //Variaveis mecanica bala
        var bulletTime = 0;
        var fireInterval = 200;
		var timeUltimoTiro = 0;
        var nextFire = 0;
        
        var balas;
        
        var Moedas;
        
        var inimigos;
        
        //Variaveis texto
        var textoDistancia = 0;
        var textoMoedas = 0;
        var textoPosition = 0;
        
        //Variaveis distancia
        var distancia = 0;
        
        var coracao;
        var coracao2;
        var coracao3;
        var vidas = 3;

		this.create = function () {
            
        game.stage.backgroundColor = "#3498db"; 
        game.physics.startSystem(Phaser.Physics.ARCADE);

        
        //AGUA
        fundo = game.add.tileSprite(0,0,1280,720, 'waterP');
        
        //FLORESTA
        florestaEsquerda = game.add.tileSprite(0,0,300,2000, 'floEsquerda'); 
        florestaDireita = game.add.tileSprite(980,0,300,2000, 'floDireita');
        game.physics.arcade.enable([florestaDireita,florestaEsquerda]);
        florestaEsquerda.body.enable = true;
        florestaDireita.body.enable = true;
        florestaDireita.body.immovable = true;
        florestaEsquerda.body.immovable = true;  
        
        //MOEDAS
        Moedas = game.add.group();
        Moedas.enableBody = true;
        Moedas.physicsBodyType = Phaser.Physics.ARCADE;    
            
        //BARCO
        barco = game.add.sprite(640,600, 'ship');          
	    game.physics.arcade.enable(barco);
        barco.body.fixedRotation = true;
        barco.body.collideWorldBounds = true;
        barco.body.enable = true;
        barco.anchor.setTo(0.5,0.5);   
            
        //Balas
        balas = game.add.group();
        balas.enableBody = true;
        balas.physicsBodyType = Phaser.Physics.ARCADE;
        balas.createMultiple(30, 'missil1');
        balas.setAll('anchor.x', 0.5);
        balas.setAll('anchor.y', 0.5);
        balas.setAll('outOfBoundsKill', true);
        balas.setAll('checkWorldBounds', true);
        
        //INIMIGO
        inimigos = game.add.group();
        inimigos.enableBody = true;
        inimigos.physicsBodyType = Phaser.Physics.ARCADE;
        inimigos.createMultiple(30, 'missil1');
        inimigos.setAll('anchor.x', 0.5);
        inimigos.setAll('anchor.y', 0.5);
        inimigos.setAll('outOfBoundsKill', true);
        inimigos.setAll('checkWorldBounds', true); 
            

       //CORAÇÕES
         coracao = game.add.sprite(1090,10,'coracao');
         coracao.scale.setTo(0.06,0.06);   
         coracao2 = game.add.sprite(1150,10,'coracao');
         coracao2.scale.setTo(0.06,0.06);    
         coracao3 = game.add.sprite(1210,10,'coracao');
         coracao3.scale.setTo(0.06,0.06);                       
            
            
            
        textoDistancia = game.add.text(10,10, 'Distance: ',{font: "40px arial", fill: "#ffffff", backgroundColor: "#34495e" , padding: "20px"});
        textoMoedas = game.add.text(10,60, 'Moedas: ',{font: "40px arial", fill: "#ffffff", backgroundColor: "#34495e" , padding: "20px"});
        textoPosition = game.add.text(10,60, 'Posição: ',{font: "40px arial", fill: "#ffffff", backgroundColor: "#34495e" , padding: "20px"});
        
        //TECLADO    
        cursors = game.input.keyboard.createCursorKeys();    
        atira = game.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR);
                  
        //Loop para contar distancia
        game.time.events.loop(100, contaDistancia, this); 
        game.time.events.loop(500, liberaInimigo, this);
        
        }
        

		this.update = function () {
            
        textoPosition.text = "Vidas: " + vidas;
         
            
        game.physics.arcade.collide(barco, [florestaDireita,florestaEsquerda]);
        game.physics.arcade.collide(barco, inimigos, descontaVida);    
        
        barco.body.velocity.setTo(0, 0);
            
        if (cursors.right.isDown)
            {
    	       barco.body.velocity.x = 400;
               //barco.body.velocity.y = -333;

            }
        else if (cursors.left.isDown)
            {
    	       barco.body.velocity.x = -400;
                
            }

        if (cursors.up.isDown)
            {
    	       barco.body.velocity.y = -400;
               
            }
        else if (cursors.down.isDown)
            {
    	       barco.body.velocity.y = 400;
               
            }

        
        //Clicar para atirar
        if (atira.isDown)
        {
			var agora = game.time.now;
			var deltaT = agora - timeUltimoTiro;
			if (deltaT >= fireInterval) {
				timeUltimoTiro = agora;
				fire();
			}
        }

        //Move o fundo
        fundo.tilePosition.y += 0.7;

        //Move florestas    
        florestaEsquerda.tilePosition.y += 0.6;
        florestaDireita.tilePosition.y += 0.6;

  
        //barco.body.onBeginContact.add(blockHit, this);    
        
        }
        
 
function contaDistancia() {

    distancia++;

    textoDistancia.setText('Distancia: ' + distancia);

}
        function mudaCor(){
            textoDistancia.text = "teste";
        }

function liberaInimigo(){
    
        var inimigo = inimigos.create(Math.random() * (980 - 300) + 300,-20, 'inimigo');
        inimigo.physicsBodyType = Phaser.Physics.ARCADE;
        inimigo.body.enable = true;
        inimigo.body.velocity.y = 400;
    
    
}

function criaMoedas(){
    
    for(var y = 0; y < 30; y++){
        
        var moeda = Moedas.create(Math.random() * 1000,game.world.randomY, 'coin');
        moeda.anchor.setTo(0.5, 0.5);
        moeda.animations.add('animMoeda', [ 0, 1, 2, 3, 4 ,5], 12, true);
        moeda.play('animMoeda');
        moeda.body.moves = false;
    }
}
function descontaVida(){
    
    vidas -= 1;
}       
function fire() {
        
    if (game.time.now > bulletTime)
    {
        
        var bala = balas.getFirstExists(false);

        if (bala)
        {
            //  And fire it
            bala.reset(barco.x, barco.y - 57);
            bala.body.velocity.y = -800;
            bulletTime = game.time.now + 200;
            bala.scale.setTo(0.4,0.4);
            
            
        }
    }
    
}

//function blockHit (body, bodyB, shapeA, shapeB, equation) {
//    if (body)
//    {
//        bala.kill();
//        player.kill();
//    }
//
//}


   
        
this.render = function (){
    //game.debug.spriteBounds(barco);
 
}
        
	
    }
	// Os estados do jogo podem ser entendidos como "telas" ou "cenários"
	// Se nosso jogo tivesse mais de uma "tela", bastaria adicionar as telas aqui,
	// dando nomes para cada uma (para alternar entre uma tela e outra, bastaria
	// executar jogo.state.start("Nome da tela") a qualquer momento)
	game.state.add("TelaInicial", TelaInicial);
	game.state.start("TelaInicial");

	//]]>
	</script>
</body>
</html>
